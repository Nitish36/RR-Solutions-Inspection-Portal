<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR Solutions | Verification</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f4f4; font-family: 'Inter', sans-serif; }
        .cert-card { max-width: 500px; margin: 30px auto; border-radius: 15px; overflow: hidden; border: none; }
        .status-banner { padding: 20px; text-align: center; font-weight: bold; font-size: 1.5rem; border-bottom: 5px solid rgba(0,0,0,0.1); }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .staff-tools { background: #e7f1ff; border: 2px dashed #0d6efd; border-radius: 15px; padding: 20px; max-width: 500px; margin: 20px auto; }
    </style>
</head>
<body>

<div class="container">
    
    <!-- 1. PRIVATE STAFF TOOLS (Only visible if logged in) -->
    {% if current_user.is_authenticated %}
    <div class="staff-tools text-center shadow-sm">
        <h4 class="text-primary">Staff Tool: Update Document</h4>
        <p class="text-muted small">Logged in as: <strong>{{ current_user.username }}</strong></p>
        
        <form id="field-upload-form" onsubmit="uploadFieldDoc(event, '{{ data.asset_id }}')">
            <input type="file" id="field-pdf" accept=".pdf,image/*" required class="form-control mb-2">
            <button type="submit" class="btn btn-primary w-100">Confirm & Upload PDF</button>
        </form>
    </div>
    {% else %}
    <div class="text-center mt-4">
        <p class="text-muted small">Public Verification Mode. <a href="/">Login</a> to modify records.</p>
    </div>
    {% endif %}

    <!-- 2. VERIFICATION CARD -->
    <div class="card cert-card shadow">
        <div class="card-header bg-white text-center py-3">
            <h4 class="mb-0" style="color: #ff0000; font-weight: 900;">RR SOLUTIONS</h4>
            <div class="text-muted small">Inspection & Testing Services</div>
        </div>

        <!-- Banner color logic -->
        {% set is_valid = data.status == 'Valid' or data.status == 'Pass' %}
        <div class="status-banner {{ 'pass' if is_valid else 'fail' }}">
            {{ '‚úÖ VERIFIED: VALID' if is_valid else '‚ùå ALERT: EXPIRED / FAILED' }}
        </div>

        <div class="card-body">
            <table class="table table-borderless">
                <tr>
                    <th class="text-muted">Asset ID:</th>
                    <td><strong>{{ data.asset_id }}</strong></td>
                </tr>
                <tr>
                    <th class="text-muted">Equipment:</th>
                    <td>{{ data.equipment }}</td>
                </tr>
                <tr>
                    <th class="text-muted">Form Type:</th>
                    <td>{{ data.form_type or 'N/A' }}</td>
                </tr>
                <tr>
                    <th class="text-muted">Project Site:</th>
                    <td>{{ data.site or 'N/A' }}</td>
                </tr>
                <tr>
                    <th class="text-muted">Inspection Date:</th>
                    <td>{{ data.inspection_date }}</td>
                </tr>
                <tr>
                    <th class="text-muted">Valid Until:</th>
                    <td class="{{ 'text-danger fw-bold' if not is_valid }}">{{ data.expiry_date }}</td>
                </tr>
            </table>
            
            {% if data.pdf_path %}
            <div class="mt-3 text-center">
                <a href="/static/pdfs/{{ data.pdf_path }}" class="btn btn-outline-dark btn-sm" target="_blank">
                    üìÑ View Digital Certificate
                </a>
            </div>
            {% endif %}
        </div>
        
        <div class="card-footer text-center py-3 bg-white">
            <small class="text-muted">Digital Record ID: {{ data.id }}<br>¬© 2026 RR Solutions</small>
        </div>
    </div>
</div>

<script>
async function uploadFieldDoc(event, assetId) {
    event.preventDefault();
    const fileInput = document.getElementById('field-pdf');
    if (fileInput.files.length === 0) return;

    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);
    formData.append('asset_id', assetId);

    try {
        const response = await fetch('/api/field_upload', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert("Success! The document has been linked to Asset " + assetId);
            location.reload(); 
        } else {
            const err = await response.json();
            alert("Upload failed: " + (err.message || "Unauthorized"));
        }
    } catch (err) {
        alert("Connection error. Check your server.");
    }
}
</script>
</body>
</html>